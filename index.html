<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="utf-8">
</head>
<body>
  
<script>
// === BaseClass.js ===
class BaseClass{
    constructor(x, y, width, height, angle) {
        var options = {
            'restitution':0.8,
            'friction':1.0,
            'density':1.0
        }
        this.body = Bodies.rectangle(x, y, width, height, options);
        this.width = width;
        this.height = height;
        this.image = loadImage("sprites/base.png");
        World.add(world, this.body);
      }
      display(){
        var angle = this.body.angle;
        push();
        translate(this.body.position.x, this.body.position.y);
        rotate(angle);
        imageMode(CENTER);
        image(this.image, 0, 0, this.width, this.height);
        pop();
      }
}

// === Ground.js ===
class Ground {
    constructor(x,y,width,height) {
      var options = {
          isStatic: true
      }
      this.body = Bodies.rectangle(x,y,width,height,options);
      this.width = width;
      this.height = height;
      World.add(world, this.body);
    }
    display(){
      var pos =this.body.position;
      rectMode(CENTER);
      fill("brown");
      rect(pos.x, pos.y, this.width, this.height);
    }
  };

// === Box.js ===
class Box extends BaseClass {
  constructor(x, y, width, height){
    super(x,y,width,height);
    this.image = loadImage("sprites/wood1.png");
  }

};

// === Pig.js ===
class Pig extends BaseClass {
  constructor(x, y){
    super(x,y,50,50);
    this.image = loadImage("sprites/enemy.png");
    this.visibility = 255; 
    this.isScored = false; 
  }

  display(){
    if(this.body.speed > 3){
      this.visibility = this.visibility - 5; 
    }

    if(this.visibility > 0){
      push();
      tint(255, this.visibility); 
      super.display(); 
      pop();
    }
    
    if(this.visibility <= 0 && !this.isScored){
      World.remove(world, this.body); 
      score += 50; 
      this.isScored = true; 
      
      if (score === 100) {
        gameState = "youWin";
      }
    }
  }
};

// === Log.js ===
class Log extends BaseClass{
  constructor(x,y,height,angle){
    super(x,y,20,height,angle);
    this.image = loadImage("sprites/wood2.png");
    Matter.Body.setAngle(this.body, angle);
  }
}

// === Bird.js ===
class Bird extends BaseClass {
  constructor(x,y){
    super(x,y,50,50);
    this.image = loadImage("sprites/bird.png");
  }

  display() {
    super.display();
  }
}

// === SlingShot.js (Reverted) ===
class SlingShot {
    constructor(bodyA, pointB){
        var options = {
            bodyA: bodyA,
            pointB: pointB,
            stiffness: 0.04,
            length: 10
        }
        this.pointB = pointB;
        this.sling = Matter.Constraint.create(options);
        World.add(world, this.sling);
    }

    fly(){
        this.sling.bodyA = null;
    }

    attach(body){
        this.sling.bodyA = body;
    }
    
    display(){
        if(this.sling.bodyA){
            var pointA = this.sling.bodyA.position;
            var pointB = this.pointB;
            
            push(); 
            stroke("rgb(48,22,8)");
            strokeWeight(7);
            
            // --- Reverted to the original line style ---
            line(pointA.x, pointA.y, pointB.x - 20, pointB.y + 10);
            line(pointA.x, pointA.y, pointB.x + 20, pointB.y + 10);
            pop(); 
        }
    }
}


// === sketch.js (Reverted to 100, 100) ===
const Engine = Matter.Engine;
const World= Matter.World;
const Bodies = Matter.Bodies;
const Constraint = Matter.Constraint; 

var engine, world;
var box1, pig1;
var backgroundImg,platform;
var bird, slingshot; 
var score = 0; 

var birdChances = 3; 
var gameState = "onSling"; 

function preload() {
    backgroundImg = loadImage("sprites/bg.png");
}

function setup(){
    var canvas = createCanvas(1200,400);
    engine = Engine.create();
    world = engine.world;


    ground = new Ground(600,height,1200,20);
    platform = new Ground(150, 305, 300, 170); // Platform still exists

    box1 = new Box(700,320,70,70);
    box2 = new Box(920,320,70,70);
    pig1 = new Pig(810, 350);
    log1 = new Log(810,260,300, PI/2);

    box3 = new Box(700,240,70,70);
    box4 = new Box(920,240,70,70);
    pig3 = new Pig(810, 220);

    log3 =  new Log(810,180,300, PI/2);

    box5 = new Box(810,160,70,70);
    log4 = new Log(760,120,150, PI/7);
    log5 = new Log(870,120,150, -PI/7);

    // BIRD POSITION: Reverted to (100, 100)
    bird = new Bird(100, 100);
    
    // SLINGSHOT ANCHOR: Reverted to (100, 100)
    slingshot = new SlingShot(bird.body, { x: 100, y: 100 });
}

function draw(){
    if (backgroundImg) {
        background(backgroundImg);
    } else {
        background("pink");
    }
    
    if (gameState === "onSling" || gameState === "launched") {
        Engine.update(engine);
        
        box1.display();
        box2.display();
        ground.display();
        pig1.display();
        log1.display();

        box3.display();
        box4.display();
        pig3.display();
        log3.display();

        box5.display();
        log4.display();
        log5.display();

        bird.display();
        platform.display(); // Platform still drawn
        slingshot.display(); 
    }
    
    drawScoreboard(); 
    
    if (birdChances === 0 && gameState === "launched" && bird.body.speed < 0.5 && gameState !== "youWin") {
        gameState = "gameOver";
    }

    // --- Display End Messages ---
    if (gameState === "gameOver") {
        push();
        fill("red");
        textSize(100);
        textAlign(CENTER, CENTER);
        text("GAME OVER", width/2, height/2);
        pop();
    }

    if (gameState === "youWin") {
        push();
        fill("green");
        textSize(100);
        textAlign(CENTER, CENTER);
        text("YOU WIN!", width/2, height/2);
        pop();
    }

    // Text prompt for reloading
    if (gameState === "launched" && birdChances > 0) {
        push();
        fill("black");
        textSize(20);
        textAlign(CENTER, CENTER);
        text("Press Spacebar to Reload Bird", width/2, height - 50);
        pop();
    }
}

function drawScoreboard() {
    push(); 
    fill(0, 0, 0, 100); 
    noStroke();
    rect(980, 20, 200, 80, 10); 
    
    fill(255); 
    textAlign(LEFT, TOP); 
    
    textSize(25);
    textFont("Georgia"); 
    text("Score: " + score, 1000, 35);
    
    textSize(20);
    textFont("Georgia");
    text("Birds Left: " + birdChances, 1000, 70);

    pop(); 
}

// MODIFIED: Reverted restriction 'x' to 100
function mouseDragged(){
    if (gameState === "onSling") {
        let newX = mouseX;
        // Don't let the bird go past the original anchor '100'
        if (mouseX > 100) { 
            newX = 100; 
        }
        Matter.Body.setPosition(bird.body, {x: newX , y: mouseY});
    }
}

function mouseReleased(){
    if (gameState === "onSling") {
        slingshot.fly();
        gameState = "launched";
        birdChances--;
    }
}

// MODIFIED: Reverted reset position to (100, 100)
function keyPressed() {
    if (keyCode === 32 && gameState !== "youWin" && gameState !== "gameOver") {
        
        let canReset = false;
        if (gameState === "launched") {
            if (bird.body.speed < 0.5) canReset = true;
            if (bird.body.position.y > height + 50) canReset = true; 
            if (bird.body.position.x < -50) canReset = true; 
            if (bird.body.position.x > width + 50) canReset = true; 
        }

        if (canReset && birdChances > 0) {
            // Reset to the original floating position
            Matter.Body.setPosition(bird.body, { x: 100, y: 100 }); 
            Matter.Body.setVelocity(bird.body, { x: 0, y: 0 });
            slingshot.attach(bird.body);
            gameState = "onSling"; 
        }
    }
}

</script>

</body>
</html>
